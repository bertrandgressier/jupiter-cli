generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// === Configuration ===

model MasterPassword {
  id                    Int      @id @default(1)
  hash                  String   // Argon2id hash of the master password
  salt                  String   // Salt used for hashing

  // Persistent Session Key (enables agent autonomy)
  encryptedSessionKey   String   // Session key encrypted with AES-256-GCM
  sessionNonce          String   // Nonce for session key decryption
  sessionSalt           String   // Salt for key derivation

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// === Wallets ===
// Minimal storage: only security-related data

model Wallet {
  id          String   @id @default(uuid()) // Opaque UUID
  name        String   @unique                 // User-defined name (unique)
  address     String   @unique                 // Solana public address
  encryptedKey String                          // Private key encrypted with AES-256-GCM
  keyNonce    String                           // Nonce for decryption
  keySalt     String                           // Salt for key derivation
  keyAuthTag  String                           // AES-256-GCM auth tag
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  lastUsed    DateTime?

  // Relations
  trades       Trade[]

  @@index([address])
  @@index([isActive])
}

// === Trades ===
// Records all swap and limit order executions for PnL calculation

model Trade {
  id             String    @id @default(uuid())
  walletId       String

  // Tokens
  inputMint      String
  outputMint     String
  inputSymbol    String?
  outputSymbol   String?

  // Amounts (human-readable, NOT smallest units)
  inputAmount    String
  outputAmount   String

  // USD prices per unit at execution time
  inputUsdPrice  String?
  outputUsdPrice String?

  // Computed USD values (amount Ã— price)
  inputUsdValue  String?
  outputUsdValue String?

  // Execution metadata
  type           String    // "swap" | "limit_order"
  signature      String    // On-chain tx signature
  executedAt     DateTime  @default(now())

  // Relations
  wallet         Wallet    @relation(fields: [walletId], references: [id])

  @@index([walletId, executedAt])
  @@index([walletId, outputMint])
  @@index([walletId, inputMint])
  @@index([signature])
}

// === Token Info ===
// Stable metadata for tokens (fetched from Jupiter API and cached)

model TokenInfo {
  mint      String   @id   // Token address (primary key)
  symbol    String         // e.g., "SOL", "USDC", "JUP"
  name      String?        // e.g., "Solana", "USD Coin"
  decimals  Int            // e.g., 9 for SOL, 6 for USDC
  logoURI   String?
  verified  Boolean  @default(false)
  fetchedAt DateTime @default(now())

  @@index([symbol])
}
