generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// === Configuration ===

model MasterPassword {
  id                    Int      @id @default(1)
  hash                  String   // Argon2id hash of the master password
  salt                  String   // Salt used for hashing

  // Persistent Session Key (enables agent autonomy)
  encryptedSessionKey   String   // Session key encrypted with AES-256-GCM
  sessionNonce          String   // Nonce for session key decryption
  sessionSalt           String   // Salt for key derivation

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// === Wallets ===
// Minimal storage: only security-related data

model Wallet {
  id          String   @id @default(uuid()) // Opaque UUID
  name        String   @unique                 // User-defined name (unique)
  address     String   @unique                 // Solana public address
  encryptedKey String                          // Private key encrypted with AES-256-GCM
  keyNonce    String                           // Nonce for decryption
  keySalt     String                           // Salt for key derivation
  keyAuthTag  String                           // AES-256-GCM auth tag
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  lastUsed    DateTime?

  // Relations
  costBasis   CostBasis[] // Average cost per token (for PnL)

  @@index([address])
  @@index([isActive])
}

// === Cost Basis ===
// Used exclusively for PnL: stores the average purchase price per token
// Everything else (balance, current price) is fetched via Jupiter API

model CostBasis {
  id              String   @id @default(uuid())
  walletId        String
  wallet          Wallet   @relation(fields: [walletId], references: [id])

  mint            String   // Token address
  symbol          String?  // Symbol (SOL, USDC, etc.)
  
  // Average acquisition cost (critical for PnL)
  avgPriceUsd     String   // Average purchase price (stored as string for precision)
  totalAcquired   String   // Total quantity acquired (stored as string for precision)
  totalCostUsd    String   // Total cost in USD (stored as string for precision)

  updatedAt       DateTime @updatedAt

  @@unique([walletId, mint]) // One entry per token per wallet
  @@index([walletId])
  @@index([mint])
}
